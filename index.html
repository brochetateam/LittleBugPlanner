<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Little Bug's Planner | 42 Academy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'Space Mono', monospace;
            background-color: #f0f8ff;
        }
        
        .bug-theme {
            background-color: #e6f9ff;
            border-left: 5px solid #4CAF50;
        }
        
        .bug-theme:hover {
            background-color: #d1f2ff;
            transform: translateY(-2px);
        }
        
        .header-bg {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
        }
        
        .task-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .task-card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        .bug-icon {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .progress-bar {
            height: 10px;
            border-radius: 5px;
            background-color: #e0e0e0;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 5px;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.5s ease;
        }
        
        .column {
            min-height: 400px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .priority-high {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        
        .priority-medium {
            background-color: #fef3c7;
            color: #b45309;
        }
        
        .priority-low {
            background-color: #dbeafe;
            color: #1d4ed8;
        }
        
        .priority-review {
            background-color: #ede9fe;
            color: #5b21b6;
        }
        
        .dropzone {
            min-height: 100px;
            transition: background-color 0.2s;
        }
        
        .dropzone.active {
            background-color: rgba(76, 175, 80, 0.1);
            border: 2px dashed #4CAF50;
        }
        
        .ghost {
            opacity: 0.4;
            background: #c8ebfb;
        }
        
        .week-planner {
            display: none;
        }
        
        .day-column {
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }
        
        .day-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, #4CAF50, transparent);
            margin: 10px 0;
            position: relative;
        }
        
        .day-divider::after {
            content: 'Noon';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.8);
            padding: 0 8px;
            font-size: 10px;
            color: #4CAF50;
            border-radius: 10px;
        }
        
        .time-slot {
            height: 250px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.9);
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }
        
        .time-slot::after {
            content: '4 hours';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 10px;
            color: #888;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .morning-slot {
            border-left: 4px solid #FFD700;
        }
        
        .afternoon-slot {
            border-left: 4px solid #1E90FF;
        }
        
        .active-view {
            background-color: rgba(255, 255, 255, 0.3);
            font-weight: bold;
        }
        
        .week-task {
            background-color: white;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: move;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .week-task:hover {
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="header-bg text-white py-6 px-4 shadow-lg">
        <div class="container mx-auto flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                <div class="bug-icon">
                    <i class="fas fa-bug text-4xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold">Little Bug's Planner</h1>
                    <p class="text-sm opacity-80">42 Academy Planning Tool</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex bg-white bg-opacity-20 rounded-full overflow-hidden">
                    <button id="planner-view-btn" class="px-4 py-2 active-view">LibFT</button>
                    <button id="week-view-btn" class="px-4 py-2">Planner</button>
                </div>
                <!-- <div class="bg-white bg-opacity-20 px-4 py-2 rounded-full flex items-center">
                    <i class="fas fa-user-graduate mr-2"></i>
                    <span>Student: Little Bug</span>
                </div> -->
                <div class="flex space-x-2">
                    <!-- <button id="export-data-btn" class="bg-blue-500 text-white px-3 py-2 rounded-full font-bold hover:bg-blue-600 transition text-sm">
                        <i class="fas fa-download mr-1"></i> Export
                    </button>
                    <button id="import-data-btn" class="bg-purple-500 text-white px-3 py-2 rounded-full font-bold hover:bg-purple-600 transition text-sm">
                        <i class="fas fa-upload mr-1"></i> Import
                    </button> -->
                    <button id="new-task-btn" class="bg-white text-green-700 px-4 py-2 rounded-full font-bold hover:bg-gray-100 transition">
                        <i class="fas fa-plus mr-2"></i> New Task
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- LibFT Planner View -->
    <div id="libft-planner" class="container mx-auto px-4 py-8">
        <!-- Progress Overview -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8 bug-theme">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">LibFT Progress</h2>
            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <div class="w-full md:w-3/4 mb-4 md:mb-0">
                    <div class="flex justify-between mb-2">
                        <span class="font-bold">Project Completion</span>
                        <span id="completion-percentage" class="font-bold">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <div class="text-center">
                        <div id="done-count" class="text-2xl font-bold text-green-600">0</div>
                        <div class="text-sm text-gray-600">Tasks Done</div>
                    </div>
                    <div class="text-center">
                        <div id="progress-count" class="text-2xl font-bold text-yellow-600">0</div>
                        <div class="text-sm text-gray-600">In Progress</div>
                    </div>
                    <div class="text-center">
                        <div id="todo-count" class="text-2xl font-bold text-red-600">0</div>
                        <div class="text-sm text-gray-600">Todo</div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                <div class="bg-green-100 p-4 rounded-lg flex items-center">
                    <div class="bg-green-500 text-white p-3 rounded-full mr-4">
                        <i class="fas fa-check"></i>
                    </div>
                    <div>
                        <h3 class="font-bold">Last Completed</h3>
                        <p id="last-completed" class="text-sm">-</p>
                    </div>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg flex items-center">
                    <div class="bg-yellow-500 text-white p-3 rounded-full mr-4">
                        <i class="fas fa-spinner"></i>
                    </div>
                    <div>
                        <h3 class="font-bold">Current Task</h3>
                        <p id="current-task" class="text-sm">-</p>
                    </div>
                </div>
                <div class="bg-blue-100 p-4 rounded-lg flex items-center">
                    <div class="bg-blue-500 text-white p-3 rounded-full mr-4">
                        <i class="fas fa-flag"></i>
                    </div>
                    <div>
                        <h3 class="font-bold">Next Priority</h3>
                        <p id="next-priority" class="text-sm">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task Board -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="task-board">
            <!-- Todo Column -->
            <div class="column p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-red-600 flex items-center">
                        <i class="fas fa-list-ul mr-2"></i> To Do
                    </h3>
                    <span id="todo-count-badge" class="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded-full">0 tasks</span>
                </div>
                
                <div class="space-y-4 task-list dropzone" data-status="todo">
                    <!-- Task cards will be added here dynamically -->
                </div>
                
                <button class="mt-4 w-full py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-600 font-medium transition flex items-center justify-center add-task-btn" data-status="todo">
                    <i class="fas fa-plus mr-2"></i> Add Task
                </button>
            </div>
            
            <!-- In Progress Column -->
            <div class="column p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-yellow-600 flex items-center">
                        <i class="fas fa-spinner mr-2"></i> In Progress
                    </h3>
                    <span id="progress-count-badge" class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-1 rounded-full">0 tasks</span>
                </div>
                
                <div class="space-y-4 task-list dropzone" data-status="progress">
                    <!-- Task cards will be added here dynamically -->
                </div>
                
                <button class="mt-4 w-full py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-600 font-medium transition flex items-center justify-center add-task-btn" data-status="progress">
                    <i class="fas fa-plus mr-2"></i> Add Task
                </button>
            </div>
            
            <!-- Done Column -->
            <div class="column p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-green-600 flex items-center">
                        <i class="fas fa-check-circle mr-2"></i> Done
                    </h3>
                    <span id="done-count-badge" class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded-full">0 tasks</span>
                </div>
                
                <div class="space-y-4 task-list dropzone" data-status="done">
                    <!-- Task cards will be added here dynamically -->
                </div>
                
                <button class="mt-4 w-full py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-600 font-medium transition flex items-center justify-center add-task-btn" data-status="done">
                    <i class="fas fa-plus mr-2"></i> Add Task
                </button>
            </div>
        </div>
        
        <!-- Resources Section -->
        <div class="mt-12 bg-white rounded-xl shadow-md p-6 bug-theme">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                <i class="fas fa-book mr-3"></i> Libft Resources (in development)
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:border-green-400 transition">
                    <div class="flex items-center mb-3">
                        <div class="bg-green-100 p-2 rounded-full mr-3">
                            <i class="fas fa-file-alt text-green-600"></i>
                        </div>
                        <h3 class="font-bold">Subject PDF</h3>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">Official LibFT project subject with requirements and instructions.</p>
                    <a href="libft_subject.pdf" class="w-full bg-green-50 text-green-700 py-2 rounded-lg font-medium hover:bg-green-100 transition flex items-center justify-center">
                        <i class="fas fa-download mr-2"></i> Download
                    </a>
                </div>
                
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:border-blue-400 transition">
                    <div class="flex items-center mb-3">
                        <div class="bg-blue-100 p-2 rounded-full mr-3">
                            <i class="fas fa-video text-blue-600"></i>
                        </div>
                        <h3 class="font-bold">Tutorial Videos</h3>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">Collection of helpful tutorials from 42 peers and mentors.</p>
                    <button class="w-full bg-blue-50 text-blue-700 py-2 rounded-lg font-medium hover:bg-blue-100 transition flex items-center justify-center">
                        <i class="fas fa-play mr-2"></i> Watch Now
                    </button>
                </div>
                
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:border-purple-400 transition">
                    <div class="flex items-center mb-3">
                        <div class="bg-purple-100 p-2 rounded-full mr-3">
                            <i class="fas fa-code text-purple-600"></i>
                        </div>
                        <h3 class="font-bold">Testers</h3>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">LibFT testers to validate your functions before evaluation.</p>
                    <button class="w-full bg-purple-50 text-purple-700 py-2 rounded-lg font-medium hover:bg-purple-100 transition flex items-center justify-center">
                        <i class="fas fa-flask mr-2"></i> Run Tests
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Week Planner View -->
    <div id="week-planner" class="week-planner container mx-auto px-4 py-8">
        <div class="bg-white rounded-xl shadow-md p-6 mb-8 bug-theme">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Week Planner</h2>
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-calendar-week mr-3 text-xl text-green-600"></i>
                    <h3 class="text-lg font-semibold">Current Week: <span id="current-week">Loading...</span></h3>
                </div>
                <button id="add-week-task" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition flex items-center">
                    <i class="fas fa-plus mr-2"></i> Add Task
                </button>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-7 gap-4">
                <!-- Monday -->
                <div class="day-column p-3">
                    <h4 class="font-bold text-center mb-3">Monday</h4>
                    <div class="morning-slot time-slot p-2 dropzone" data-day="monday" data-time="morning">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium"><i class="fas fa-sun mr-1 text-yellow-500"></i> Morning</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">0 tasks</span>
                        </div>
                        <div class="week-tasks" data-day="monday" data-time="morning"></div>
                    </div>
                    <div class="day-divider"></div>
                    <div class="afternoon-slot time-slot p-2 dropzone" data-day="monday" data-time="afternoon">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium"><i class="fas fa-cloud-sun mr-1 text-blue-500"></i> Afternoon</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">0 tasks</span>
                        </div>
                        <div class="week-tasks" data-day="monday" data-time="afternoon"></div>
                    </div>
                </div>
                
                <!-- Tuesday -->
                <div class="day-column p-3">
                    <h4 class="font-bold text-center mb-3">Tuesday</h4>
                    <div class="morning-slot time-slot p-2 dropzone" data-day="tuesday" data-time="morning">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium"><i class="fas fa-sun mr-1 text-yellow-500"></i> Morning</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">0 tasks</span>
                        </div>
                        <div class="week-tasks" data-day="tuesday" data-time="morning"></div>
                    </div>
                    <div class="day-divider"></div>
                    <div class="afternoon-slot time-slot p-2 dropzone" data-day="tuesday" data-time="afternoon">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium"><i class="fas fa-cloud-sun mr-1 text-blue-500"></i> Afternoon</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">0 tasks</span>
                        </div>
                        <div class="week-tasks" data-day="tuesday" data-time="afternoon"></div>
                    </div>
                </div>
                
                <!-- Wednesday -->
                <div class="day-column p-3">
                    <h4 class="font-bold text-center mb-3">Wednesday</h4>
                    <div class="morning-slot time-slot p-2 dropzone" data-day="wednesday" data-time="morning">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium"><i class="fas fa-sun mr-1 text-yellow-500"></i> Morning</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">0 tasks</span>
                        </div>
                        <div class="week-tasks" data-day="wednesday" data-time="morning"></div>
                    </div>
                    <div class="day-divider"></div>
                    <div class="afternoon-slot time-slot p-2 dropzone" data-day="wednesday" data-time="afternoon">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium"><i class="fas fa-cloud-sun mr-1 text-blue-500"></i> Afternoon</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">0 tasks</span>
                        </div>
                        <div class="week-tasks" data-day="wednesday" data-time="afternoon"></div>
                    </div>
                </div>
                
                <!-- Thursday -->
                <div class="day-column p-3">
                    <h4 class="font-bold text-center mb-3">Thursday</h4>
                    <div class="morning-slot time-slot p-2 dropzone" data-day="thursday" data-time="morning">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium"><i class="fas fa-sun mr-1 text-yellow-500"></i> Morning</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">0 tasks</span>
                        </div>
                        <div class="week-tasks" data-day="thursday" data-time="morning"></div>
                    </div>
                    <div class="day-divider"></div>
                    <div class="afternoon-slot time-slot p-2 dropzone" data-day="thursday" data-time="afternoon">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium"><i class="fas fa-cloud-sun mr-1 text-blue-500"></i> Afternoon</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">0 tasks</span>
                        </div>
                        <div class="week-tasks" data-day="thursday" data-time="afternoon"></div>
                    </div>
                </div>
                
                <!-- Friday -->
                <div class="day-column p-3">
                    <h4 class="font-bold text-center mb-3">Friday</h4>
                    <div class="morning-slot time-slot p-2 dropzone" data-day="friday" data-time="morning">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium"><i class="fas fa-sun mr-1 text-yellow-500"></i> Morning</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">0 tasks</span>
                        </div>
                        <div class="week-tasks" data-day="friday" data-time="morning"></div>
                    </div>
                    <div class="day-divider"></div>
                    <div class="afternoon-slot time-slot p-2 dropzone" data-day="friday" data-time="afternoon">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium"><i class="fas fa-cloud-sun mr-1 text-blue-500"></i> Afternoon</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">0 tasks</span>
                        </div>
                        <div class="week-tasks" data-day="friday" data-time="afternoon"></div>
                    </div>
                </div>
                
                <!-- Saturday -->
                <div class="day-column p-3">
                    <h4 class="font-bold text-center mb-3">Saturday</h4>
                    <div class="morning-slot time-slot p-2 dropzone" data-day="saturday" data-time="morning">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium"><i class="fas fa-sun mr-1 text-yellow-500"></i> Morning</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">0 tasks</span>
                        </div>
                        <div class="week-tasks" data-day="saturday" data-time="morning"></div>
                    </div>
                    <div class="day-divider"></div>
                    <div class="afternoon-slot time-slot p-2 dropzone" data-day="saturday" data-time="afternoon">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium"><i class="fas fa-cloud-sun mr-1 text-blue-500"></i> Afternoon</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">0 tasks</span>
                        </div>
                        <div class="week-tasks" data-day="saturday" data-time="afternoon"></div>
                    </div>
                </div>
                
                <!-- Sunday -->
                <div class="day-column p-3">
                    <h4 class="font-bold text-center mb-3">Sunday</h4>
                    <div class="morning-slot time-slot p-2 dropzone" data-day="sunday" data-time="morning">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium"><i class="fas fa-sun mr-1 text-yellow-500"></i> Morning</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">0 tasks</span>
                        </div>
                        <div class="week-tasks" data-day="sunday" data-time="morning"></div>
                    </div>
                    <div class="day-divider"></div>
                    <div class="afternoon-slot time-slot p-2 dropzone" data-day="sunday" data-time="afternoon">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium"><i class="fas fa-cloud-sun mr-1 text-blue-500"></i> Afternoon</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">0 tasks</span>
                        </div>
                        <div class="week-tasks" data-day="sunday" data-time="afternoon"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Task Modal -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold">New Task</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="task-form">
                <input type="hidden" id="task-id">
                <input type="hidden" id="task-view" value="planner">
                
                <div class="mb-4">
                    <label for="task-title" class="block text-sm font-medium text-gray-700 mb-1">Task Title</label>
                    <input type="text" id="task-title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                
                <div class="mb-4">
                    <label for="task-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="task-description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                </div>
                
                <div id="planner-fields">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="task-priority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                            <select id="task-priority" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                                <option value="review">Review</option>
                            </select>
                        </div>
                        <div>
                            <label for="task-due" class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                            <input type="date" id="task-due" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="task-type" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select id="task-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="mandatory">Mandatory</option>
                            <option value="bonus">Bonus</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label for="task-status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="task-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="todo">To Do</option>
                            <option value="progress">In Progress</option>
                            <option value="done">Done</option>
                        </select>
                    </div>
                </div>
                
                <div id="week-fields" class="hidden">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="task-day" class="block text-sm font-medium text-gray-700 mb-1">Day</label>
                            <select id="task-day" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="monday">Monday</option>
                                <option value="tuesday">Tuesday</option>
                                <option value="wednesday">Wednesday</option>
                                <option value="thursday">Thursday</option>
                                <option value="friday">Friday</option>
                                <option value="saturday">Saturday</option>
                                <option value="sunday">Sunday</option>
                            </select>
                        </div>
                        <div>
                            <label for="task-time" class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                            <select id="task-time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="morning">Morning</option>
                                <option value="afternoon">Afternoon</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="task-duration" class="block text-sm font-medium text-gray-700 mb-1">Duration (hours)</label>
                        <input type="number" id="task-duration" min="0.5" max="8" step="0.5" value="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="delete-task" class="px-4 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200 transition hidden">
                        Delete
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">
                        Save Task
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <div class="mr-3 text-2xl">
                        <i class="fas fa-bug"></i>
                    </div>
                    <div>
                        <div class="font-bold">Little Bug's Planner</div>
                        <div class="text-xs text-gray-400">42 Academy Planning Tool</div>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <a href="#" class="hover:text-green-400 transition">
                        <i class="fab fa-github"></i>
                    </a>
                    <a href="#" class="hover:text-green-400 transition">
                        <i class="fab fa-slack"></i>
                    </a>
                    <a href="#" class="hover:text-green-400 transition">
                        <i class="fas fa-envelope"></i>
                    </a>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-700 text-center text-sm text-gray-400">
                Made with <i class="fas fa-heart text-red-400"></i> for 42 Academy by Little Bug
            </div>
        </div>
    </footer>

    <!-- Firebase Scripts -->
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="auth.js"></script>
    
    <script>

        // DOM elements
        const libftPlanner = document.getElementById('libft-planner');
        const weekPlanner = document.getElementById('week-planner');
        const plannerViewBtn = document.getElementById('planner-view-btn');
        const weekViewBtn = document.getElementById('week-view-btn');
        const taskBoard = document.getElementById('task-board');
        const taskModal = document.getElementById('task-modal');
        const taskForm = document.getElementById('task-form');
        const closeModal = document.getElementById('close-modal');
        const newTaskBtn = document.getElementById('new-task-btn');
        const addWeekTaskBtn = document.getElementById('add-week-task');
        const addTaskBtns = document.querySelectorAll('.add-task-btn');
        const deleteTaskBtn = document.getElementById('delete-task');
        const plannerFields = document.getElementById('planner-fields');
        const weekFields = document.getElementById('week-fields');
        const currentWeekDisplay = document.getElementById('current-week');
        
        // Stats elements
        const completionPercentage = document.getElementById('completion-percentage');
        const progressFill = document.getElementById('progress-fill');
        const doneCount = document.getElementById('done-count');
        const progressCount = document.getElementById('progress-count');
        const todoCount = document.getElementById('todo-count');
        const lastCompleted = document.getElementById('last-completed');
        const currentTask = document.getElementById('current-task');
        const nextPriority = document.getElementById('next-priority');
        const todoCountBadge = document.getElementById('todo-count-badge');
        const progressCountBadge = document.getElementById('progress-count-badge');
        const doneCountBadge = document.getElementById('done-count-badge');

        // Initialize the app
        function init() {
            setupEventListeners();
            updateCurrentWeekDisplay();
        }
        
        // Save tasks to localStorage
        function saveTasksToLocalStorage() {
            console.warn("Llamada a saveTasksToLocalStorage() - debe ser eliminada");
        }
        
        // Load tasks from localStorage
        function loadTasksFromLocalStorage() {
            console.warn("Llamada a loadTasksFromLocalStorage() - debe ser eliminada");
        }

        // Render all tasks to the board
        function renderTasks(tasksData) {
            // Clear all task lists
            document.querySelectorAll('.task-list').forEach(list => {
                list.innerHTML = '';
            });
            
            // Clear all week tasks
            document.querySelectorAll('.week-tasks').forEach(list => {
                list.innerHTML = '';
            });
            
            // Render each task
            if (Array.isArray(tasksData)) {
                tasksData.forEach(task => {
                if (task.view === 'planner') {
                    renderPlannerTask(task);
                } else if (task.view === 'week') {
                    renderWeekTask(task);
                }
            });
            }
            
            // Update task counts in week planner
            updateWeekTaskCounts(tasksData);
        }

        // Render a single planner task to the board
        function renderPlannerTask(task) {
            const taskList = document.querySelector(`.task-list[data-status="${task.status}"]`);
            
            if (!taskList) return;
            
            const taskElement = document.createElement('div');
            taskElement.className = `task-card bg-white p-4 rounded-lg shadow-sm border-l-4 cursor-move ${getBorderClass(task)}`;
            taskElement.setAttribute('draggable', 'true');
            taskElement.setAttribute('data-task-id', task.id);
            
            if (task.status === 'done') {
                taskElement.classList.add('opacity-90');
            }
            
            const dueText = task.status === 'done' ? 
                `Completed: ${formatCompletedDate(task.completedDate)}` : 
                `Due: ${formatDueDate(task.due)}`;
            
            taskElement.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-bold text-gray-800">${task.title}</h4>
                    <div class="flex space-x-2">
                        <span class="${getPriorityClass(task)} text-xs px-2 py-1 rounded-full">${formatPriority(task.priority)}</span>
                        <button class="edit-task text-gray-400 hover:text-gray-600">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mb-3">${task.description}</p>
                <div class="flex justify-between items-center text-xs text-gray-500">
                    <div class="flex items-center">
                        <i class="far fa-clock mr-1"></i>
                        <span>${dueText}</span>
                    </div>
                    <div class="flex items-center">
                        <i class="${task.type === 'bonus' ? 'fas fa-star' : 'fas fa-code-branch'} mr-1"></i>
                        <span>${task.type === 'bonus' ? 'Bonus' : 'Mandatory'}</span>
                    </div>
                </div>
                ${task.status === 'progress' ? `
                <div class="mt-2">
                    <div class="flex items-center">
                        <div class="w-8 h-8 ${getUserStatusClass(task)} rounded-full flex items-center justify-center text-xs font-bold">LB</div>
                        <div class="ml-2 text-xs text-gray-600">${getUserStatusText(task)}</div>
                    </div>
                </div>` : ''}
            `;
            
            taskList.appendChild(taskElement);
            
            // Add event listeners to the task
            const editBtn = taskElement.querySelector('.edit-task');
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openEditModal(task.id);
            });
            
            // Add double-click event for editing
            taskElement.addEventListener('dblclick', () => openEditModal(task.id));
        }

        // Render a single week task to the board
        function renderWeekTask(task) {
            const taskList = document.querySelector(`.week-tasks[data-day="${task.day}"][data-time="${task.time}"]`);
            
            if (!taskList) return;
            
            const taskElement = document.createElement('div');
            taskElement.className = 'week-task';
            taskElement.setAttribute('draggable', 'true');
            taskElement.setAttribute('data-task-id', task.id);
            
            // Add warning class if duration exceeds 4 hours
            const durationClass = task.duration > 4 ? 'bg-red-100 border border-red-300' : '';
            
            taskElement.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <h4 class="font-bold text-sm text-gray-800">${task.title}</h4>
                    <div class="flex space-x-2">
                        <span class="text-xs ${task.duration > 4 ? 'bg-red-100 text-red-800' : 'bg-gray-100'} px-2 py-1 rounded-full">${task.duration}h ${task.duration > 4 ? '⚠️' : ''}</span>
                        <button class="edit-task text-gray-400 hover:text-gray-600 text-sm">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
                <p class="text-xs text-gray-600">${task.description}</p>
                ${task.duration > 4 ? '<p class="text-xs text-red-600 mt-1">⚠️ Excede el límite de 4 horas</p>' : ''}
            `;
            
            taskList.appendChild(taskElement);
            
            // Add warning class to element if it exceeds 4 hours
            if (task.duration > 4) {
                taskElement.classList.add('bg-red-50', 'border', 'border-red-200');
            }
            
            // Add event listeners to the task
            const editBtn = taskElement.querySelector('.edit-task');
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openEditModal(task.id);
            });
            
            // Add double-click event for editing
            taskElement.addEventListener('dblclick', () => openEditModal(task.id));
        }

        // Get border class based on task status
        function getBorderClass(task) {
            if (task.status === 'todo') return 'border-red-500';
            if (task.status === 'progress') return 'border-yellow-500';
            if (task.status === 'done') return 'border-green-500';
            return 'border-gray-500';
        }

        // Get priority class based on task priority
        function getPriorityClass(task) {
            if (task.priority === 'high') return 'priority-high';
            if (task.priority === 'medium') return 'priority-medium';
            if (task.priority === 'low') return 'priority-low';
            if (task.priority === 'review') return 'priority-review';
            return 'bg-gray-100 text-gray-800';
        }

        // Get user status class based on task priority
        function getUserStatusClass(task) {
            if (task.priority === 'high') return 'bg-green-200';
            if (task.priority === 'medium') return 'bg-yellow-200';
            if (task.priority === 'review') return 'bg-purple-200';
            return 'bg-blue-200';
        }

        // Get user status text based on task priority
        function getUserStatusText(task) {
            if (task.priority === 'high') return 'Working on it';
            if (task.priority === 'medium') return 'In progress';
            if (task.priority === 'review') return 'Needs testing';
            return 'Started';
        }

        // Format priority for display
        function formatPriority(priority) {
            return priority.charAt(0).toUpperCase() + priority.slice(1);
        }

        // Format due date for display
        function formatDueDate(dateString) {
            if (!dateString) return 'No due date';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const dueDate = new Date(dateString);
            dueDate.setHours(0, 0, 0, 0);
            
            const diffTime = dueDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Tomorrow';
            if (diffDays === -1) return 'Yesterday';
            if (diffDays < 0) return `${Math.abs(diffDays)} days ago`;
            
            return `In ${diffDays} days`;
        }

        // Format completed date for display
        function formatCompletedDate(dateString) {
            if (!dateString) return 'Recently';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const completedDate = new Date(dateString);
            completedDate.setHours(0, 0, 0, 0);
            
            const diffTime = today - completedDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            
            return `${diffDays} days ago`;
        }

        // Update task counts in week planner
        function updateWeekTaskCounts(tasksData) {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const times = ['morning', 'afternoon'];
            
            days.forEach(day => {
                times.forEach(time => {
                    const tasksInSlot = Array.isArray(tasksData) ? tasksData.filter(task => 
                        task.view === 'week' && 
                        task.day === day && 
                        task.time === time
                    ) : [];
                    
                    const count = tasksInSlot.length;
                    const totalHours = tasksInSlot.reduce((sum, task) => sum + task.duration, 0);
                    const hoursPercentage = Math.min(totalHours / 4 * 100, 100);
                    
                    const badge = document.querySelector(`.time-slot[data-day="${day}"][data-time="${time}"] .text-xs`);
                    const timeSlot = document.querySelector(`.time-slot[data-day="${day}"][data-time="${time}"]`);
                    
                    if (badge) {
                        badge.textContent = `${count} ${count === 1 ? 'task' : 'tasks'} (${totalHours}/4h)`;
                        badge.className = totalHours > 4 ? 'text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full' : 'text-xs bg-gray-100 px-2 py-1 rounded-full';
                    }
                    
                    // Add progress bar to visually show hours used
                    let progressBar = timeSlot.querySelector('.hours-progress');
                    
                    if (!progressBar) {
                        progressBar = document.createElement('div');
                        progressBar.className = 'hours-progress w-full h-1 bg-gray-200 mt-1 rounded-full overflow-hidden';
                        const progressFill = document.createElement('div');
                        progressFill.className = 'h-full rounded-full';
                        progressBar.appendChild(progressFill);
                        
                        // Insertar después del encabezado del bloque de tiempo
                        const header = timeSlot.querySelector('.flex.items-center.justify-between');
                        if (header && header.nextSibling) {
                            timeSlot.insertBefore(progressBar, header.nextSibling);
                        } else {
                            timeSlot.appendChild(progressBar);
                        }
                    }
                    
                    const progressFill = progressBar.querySelector('div');
                    progressFill.style.width = `${hoursPercentage}%`;
                    progressFill.style.backgroundColor = totalHours > 4 ? '#f87171' : (totalHours > 3 ? '#fcd34d' : '#4ade80');
                    progressFill.title = `${totalHours}/4 hours used`;
                    
                    // Cambiar el estilo del bloque de tiempo si está sobrecargado
                    if (totalHours > 4) {
                        timeSlot.classList.add('border', 'border-red-300', 'bg-red-50');
                    } else {
                        timeSlot.classList.remove('border', 'border-red-300', 'bg-red-50');
                    }
                });
            });
        }

        // Update current week display
        function updateCurrentWeekDisplay() {
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay() + 1); // Monday
            const endOfWeek = new Date(now);
            endOfWeek.setDate(now.getDate() - now.getDay() + 7); // Sunday
            
            const options = { month: 'short', day: 'numeric' };
            const startStr = startOfWeek.toLocaleDateString(undefined, options);
            const endStr = endOfWeek.toLocaleDateString(undefined, options);
            
            currentWeekDisplay.textContent = `${startStr} - ${endStr}`;
        }

        // Update statistics
        function updateStats(tasksData) {
            const plannerTasks = Array.isArray(tasksData) ? tasksData.filter(task => task.view === 'planner') : [];
            const totalTasks = plannerTasks.length;
            const doneTasks = plannerTasks.filter(task => task.status === 'done').length;
            const progressTasks = plannerTasks.filter(task => task.status === 'progress').length;
            const todoTasks = plannerTasks.filter(task => task.status === 'todo').length;
            
            // Update counts
            doneCount.textContent = doneTasks;
            progressCount.textContent = progressTasks;
            todoCount.textContent = todoTasks;
            
            // Update badges
            todoCountBadge.textContent = `${todoTasks} ${todoTasks === 1 ? 'task' : 'tasks'}`;
            progressCountBadge.textContent = `${progressTasks} ${progressTasks === 1 ? 'task' : 'tasks'}`;
            doneCountBadge.textContent = `${doneTasks} ${doneTasks === 1 ? 'task' : 'tasks'}`;
            
            // Update completion percentage
            const percentage = totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0;
            completionPercentage.textContent = `${percentage}%`;
            progressFill.style.width = `${percentage}%`;
            
            // Update last completed task
            const completedTasks = plannerTasks.filter(task => task.status === 'done')
                .sort((a, b) => new Date(b.completedDate) - new Date(a.completedDate));
            
            lastCompleted.textContent = completedTasks.length > 0 ? completedTasks[0].title : '-';
            
            // Update current task (first in progress task by priority)
            const inProgressTasks = plannerTasks.filter(task => task.status === 'progress')
                .sort((a, b) => {
                    const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2, 'review': 3 };
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                });
            
            currentTask.textContent = inProgressTasks.length > 0 ? inProgressTasks[0].title : '-';
            
            // Update next priority (first todo task by priority)
            const todoTasksSorted = plannerTasks.filter(task => task.status === 'todo')
                .sort((a, b) => {
                    const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2, 'review': 3 };
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                });
            
            nextPriority.textContent = todoTasksSorted.length > 0 ? todoTasksSorted[0].title : '-';
        }

        // Expose functions globally for auth.js to call
        window.renderPlannerUI = renderTasks;
        window.updatePlannerStats = updateStats;
        window.handleEditRequest = openEditModal;

        // Setup event listeners
        function setupEventListeners() {
            // View toggle buttons
            plannerViewBtn.addEventListener('click', () => {
                libftPlanner.style.display = 'block';
                weekPlanner.style.display = 'none';
                plannerViewBtn.classList.add('active-view');
                weekViewBtn.classList.remove('active-view');
                document.getElementById('task-view').value = 'planner';
            });
            
            weekViewBtn.addEventListener('click', () => {
                libftPlanner.style.display = 'none';
                weekPlanner.style.display = 'block';
                plannerViewBtn.classList.remove('active-view');
                weekViewBtn.classList.add('active-view');
                document.getElementById('task-view').value = 'week';
            });
            
            // New task button
            newTaskBtn.addEventListener('click', () => {
                const currentView = weekPlanner.style.display === 'block' ? 'week' : 'planner';
                openNewModal(currentView);
            });
            
            // Add week task button
            addWeekTaskBtn.addEventListener('click', () => openNewModal('week'));
            
            // Add task buttons in each column
            addTaskBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const status = btn.getAttribute('data-status');
                    openNewModal('planner', status);
                });
            });
            
            // Close modal button
            closeModal.addEventListener('click', () => closeTaskModal());
            
            // Task form submission
            taskForm.addEventListener('submit', handleTaskSubmit);
            
            // Delete task button
            deleteTaskBtn.addEventListener('click', handleDeleteTask);
            
            // Exportar e importar datos (Comentado porque los botones HTML están comentados)
            // document.getElementById('export-data-btn').addEventListener('click', exportTasks);
            // document.getElementById('import-data-btn').addEventListener('click', importTasks);
            
            // Drag and drop functionality
            setupDragAndDrop();
        }

        // Setup drag and drop with improved functionality
        function setupDragAndDrop() {
            let draggedItem = null;
            let dropzone = null;
            let ghostElement = null;
            
            // Add event listeners to all task cards
            document.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('task-card') || e.target.classList.contains('week-task')) {
                    draggedItem = e.target;
                    
                    if (e.target.classList.contains('task-card')) {
                        e.target.classList.add('dragging');
                    }
                    
                    // Create a ghost element for better visual feedback
                    ghostElement = e.target.cloneNode(true);
                    ghostElement.classList.add('ghost');
                    ghostElement.style.position = 'absolute';
                    ghostElement.style.pointerEvents = 'none';
                    ghostElement.style.width = `${e.target.offsetWidth}px`;
                    document.body.appendChild(ghostElement);
                    
                    // Set the drag image to be transparent
                    e.dataTransfer.setDragImage(new Image(), 0, 0);
                }
            });
            
            document.addEventListener('dragend', function(e) {
                if (draggedItem) {
                    if (draggedItem.classList.contains('task-card')) {
                        draggedItem.classList.remove('dragging');
                    }
                    
                    // Remove ghost element
                    if (ghostElement) {
                        ghostElement.remove();
                        ghostElement = null;
                    }
                    
                    // Reset dropzone highlighting
                    if (dropzone) {
                        dropzone.classList.remove('active');
                        dropzone = null;
                    }
                    
                    draggedItem = null;
                }
            });
            
            // Handle dragover for dropzones
            document.addEventListener('dragover', function(e) {
                e.preventDefault();
                
                // Update ghost position
                if (ghostElement) {
                    ghostElement.style.top = `${e.clientY - 20}px`;
                    ghostElement.style.left = `${e.clientX - 20}px`;
                }
                
                // Find the closest dropzone
                const element = document.elementFromPoint(e.clientX, e.clientY);
                const newDropzone = element?.closest('.dropzone');
                
                // Update dropzone highlighting
                if (newDropzone !== dropzone) {
                    if (dropzone) {
                        dropzone.classList.remove('active');
                    }
                    dropzone = newDropzone;
                    if (dropzone) {
                        dropzone.classList.add('active');
                    }
                }
            });
            
            // Handle drop event
            document.addEventListener('drop', function(e) {
                e.preventDefault();
                
                // Find the dropzone being dropped onto
                const element = document.elementFromPoint(e.clientX, e.clientY);
                const currentDropzone = element?.closest('.dropzone');

                if (draggedItem && currentDropzone) {
                    const taskId = draggedItem.getAttribute('data-task-id'); // Get task ID from dragged item
                    
                    // Determine if it's planner or week view drop
                    if (currentDropzone.hasAttribute('data-status')) {
                        // Planner drop
                        const newStatus = currentDropzone.getAttribute('data-status');
                        const taskElement = document.querySelector(`.task-card[data-task-id='${taskId}']`);
                        const oldStatus = taskElement?.closest('.dropzone')?.getAttribute('data-status');

                        if (newStatus && oldStatus !== newStatus) {
                            // Call the exposed function from auth.js
                            if (window.updateTaskStatus) {
                                window.updateTaskStatus(taskId, newStatus);
                            } else {
                                console.error('window.updateTaskStatus is not available');
                            }
                        } else {
                            console.log("Planner task dropped in the same column or invalid drop.");
                        }

                    } else if (currentDropzone.hasAttribute('data-day') && currentDropzone.hasAttribute('data-time')) {
                        // Week drop
                        const newDay = currentDropzone.getAttribute('data-day');
                        const newTime = currentDropzone.getAttribute('data-time');
                        const taskElement = document.querySelector(`.week-task[data-task-id='${taskId}']`);
                        const oldDay = taskElement?.closest('.dropzone')?.getAttribute('data-day');
                        const oldTime = taskElement?.closest('.dropzone')?.getAttribute('data-time');

                        if (newDay && newTime && (oldDay !== newDay || oldTime !== newTime)){
                             // Call the local function which handles validation and calls window.updateTask
                        updateWeekTaskTime(taskId, newDay, newTime);
                        } else {
                             console.log("Week task dropped in the same slot or invalid drop.");
                        }
                       
                    } else {
                         console.log('Dropped on an unrecognized dropzone');
                    }

                    // Reset dropzone highlighting (moved from dragend for reliability)
                    currentDropzone.classList.remove('active');
                }
                
                // Remove ghost element and reset dragged item
                if (ghostElement) {
                    ghostElement.remove();
                    ghostElement = null;
                }
                 if (draggedItem) {
                    if (draggedItem.classList.contains('task-card')) {
                        draggedItem.classList.remove('dragging');
                    }
                    draggedItem = null;
                }
                // Clean up any remaining active dropzones (just in case)
                document.querySelectorAll('.dropzone.active').forEach(dz => dz.classList.remove('active'));
            });
            
            // Hacer que todas las zonas de tiempo sean dropzones válidas para cualquier tarea
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('active');
                });
                
                slot.addEventListener('dragleave', function() {
                    this.classList.remove('active');
                });
            });
        }

        // Update task status
        function updateTaskStatus(taskId, newStatus) {
            const taskIndex = tasks.findIndex(task => task.id === taskId);
            
            if (taskIndex !== -1 && tasks[taskIndex].view === 'planner') {
                // If moving to done, set completed date
                if (newStatus === 'done' && tasks[taskIndex].status !== 'done') {
                    tasks[taskIndex].completedDate = new Date().toISOString().split('T')[0];
                }
                
                // If moving away from done, clear completed date
                if (newStatus !== 'done' && tasks[taskIndex].status === 'done') {
                    tasks[taskIndex].completedDate = null;
                }
                
                tasks[taskIndex].status = newStatus;
                
                // Save to localStorage
                saveTasksToLocalStorage();
                
                // Re-render tasks and update stats
                renderTasks();
                updateStats();
            }
        }

        // Update week task day/time
        async function updateWeekTaskTime(taskId, newDay, newTime) {
            
            if (!window.getTaskData || !window.updateTask) {
                console.error('Required functions (getTaskData/updateTask) not found on window');
                alert('Error: No se pueden mover las tareas ahora mismo.');
                return;
            }

            try {
                // 1. Get current task data
                const resultGet = await window.getTaskData(taskId);
                
                if (!resultGet.success) {
                    throw new Error(resultGet.error || 'No se pudo obtener la información de la tarea.');
                }
                const currentTaskData = resultGet.task;

                // 2. (Optional but recommended) Add capacity validation here 
                //    using currentTaskData.duration and fetching tasks in the target slot.
                //    Skipping for now for simplicity.

                // 3. Prepare the *complete* data object for update
                const updatedTaskData = {
                    ...currentTaskData, // Keep existing data
                    day: newDay,         // Update day
                    time: newTime        // Update time
                };
                // Remove the ID from the data object itself if it exists, as it's passed separately
                delete updatedTaskData.id; 

                // 4. Call updateTask with the complete data
                const resultUpdate = await window.updateTask(taskId, updatedTaskData);
                
                if (resultUpdate.success) {
                    console.log(`Week task ${taskId} moved to ${newDay} ${newTime}`);
                    // UI updates automatically via loadUserData called in updateTask
                } else {
                    // Error alert is likely shown within updateTask
                    console.error('Failed to update week task time via window.updateTask.');
                    // Force UI refresh to revert visual drag?
                    if (window.loadUserData) window.loadUserData(); 
                }

            } catch (error) {
                console.error('Error in updateWeekTaskTime:', error);
                alert('Error al mover la tarea de la semana: ' + error.message);
                 if (window.loadUserData) window.loadUserData(); // Revert UI on unexpected errors
            }
        }

        // Open modal for new task
        function openNewModal(view = 'planner', status = 'todo') {
            document.getElementById('modal-title').textContent = 'New Task';
            document.getElementById('task-id').value = '';
            document.getElementById('task-title').value = '';
            document.getElementById('task-description').value = '';
            document.getElementById('task-view').value = view;
            
            if (view === 'planner') {
                document.getElementById('task-priority').value = 'medium';
                document.getElementById('task-due').value = '';
                document.getElementById('task-type').value = 'mandatory';
                document.getElementById('task-status').value = status;
                
                plannerFields.classList.remove('hidden');
                weekFields.classList.add('hidden');
            } else {
                document.getElementById('task-day').value = 'monday';
                document.getElementById('task-time').value = 'morning';
                document.getElementById('task-duration').value = '1';
                
                plannerFields.classList.add('hidden');
                weekFields.classList.remove('hidden');
            }
            
            // Hide delete button for new tasks
            deleteTaskBtn.classList.add('hidden');
            
            // Show modal
            taskModal.style.display = 'flex';
        }

        // Open modal for editing task
        // MODIFIED: Fetches task data from Firestore first
        async function openEditModal(taskId) { 
            
            if (!window.getTaskData) {
                console.error('getTaskData function not found on window');
                alert('Error: No se puede cargar la tarea para editar.');
                return;
            }

            try {
                // 1. Fetch task data using the global function
                const resultGet = await window.getTaskData(taskId);

                if (!resultGet.success) {
                    throw new Error(resultGet.error || 'No se encontró la tarea para editar.');
                }
                const task = resultGet.task;

                // 2. Populate the modal form with fetched data
                document.getElementById('modal-title').textContent = 'Edit Task';
                document.getElementById('task-id').value = task.id; // Use the ID from fetched data
                document.getElementById('task-title').value = task.title || '';
                document.getElementById('task-description').value = task.description || '';
                document.getElementById('task-view').value = task.view;
                
                if (task.view === 'planner') {
                    document.getElementById('task-priority').value = task.priority || 'medium';
                    // Handle date formatting (Firestore might return Timestamp or string)
                    let dueDate = '';
                    if (task.due) {
                        if (task.due.toDate) { // Firestore Timestamp
                            dueDate = task.due.toDate().toISOString().split('T')[0];
                        } else if (typeof task.due === 'string') {
                             // Assume YYYY-MM-DD format if string
                            dueDate = task.due.split('T')[0]; 
                        }
                    }
                    document.getElementById('task-due').value = dueDate;
                    document.getElementById('task-type').value = task.type || 'mandatory';
                    document.getElementById('task-status').value = task.status || 'todo';
                    
                    plannerFields.classList.remove('hidden');
                    weekFields.classList.add('hidden');
                } else { // Week view
                    document.getElementById('task-day').value = task.day || 'monday';
                    document.getElementById('task-time').value = task.time || 'morning';
                    document.getElementById('task-duration').value = task.duration || 1;
                    
                    plannerFields.classList.add('hidden');
                    weekFields.classList.remove('hidden');
                }
                
                // Show delete button for existing tasks
                deleteTaskBtn.classList.remove('hidden');
                
                // Show modal
                taskModal.style.display = 'flex';

            } catch (error) {
                console.error('Error opening edit modal:', error);
                alert('Error al cargar la tarea para editar: ' + error.message);
            }
        }

        // Close task modal
        function closeTaskModal() {
            taskModal.style.display = 'none';
        }

        // Handle task form submission
        async function handleTaskSubmit(e) { 
            e.preventDefault();
            
            const taskId = document.getElementById('task-id').value;
            const view = document.getElementById('task-view').value;
            
            // Construct taskData based on view
            let taskData = {
                title: document.getElementById('task-title').value.trim(),
                description: document.getElementById('task-description').value.trim(),
                view: view,
            };

            if (view === 'planner') {
                taskData = {
                    ...taskData,
                    priority: document.getElementById('task-priority').value,
                    due: document.getElementById('task-due').value || null,
                    type: document.getElementById('task-type').value,
                    status: document.getElementById('task-status').value,
                };
            } else { // Week view
                const duration = parseFloat(document.getElementById('task-duration').value);
                 // Basic duration validation (more might be needed)
                 if (isNaN(duration) || duration <= 0) {
                     alert('Please enter a valid duration (hours).');
                     return;
                 }
                 // !! Capacity check during drop/update is better than here !!
                 /*
                if (duration > 4) {
                     alert('Tasks cannot exceed 4 hours per time block.');
                    return;
                 }
                 */
                taskData = {
                    ...taskData,
                    day: document.getElementById('task-day').value,
                    time: document.getElementById('task-time').value,
                    duration: duration,
                };
            }

             if (!taskData.title) {
                alert('Please enter a title for the task');
                return;
            }

            // Disable button
            const saveButton = taskForm.querySelector('button[type="submit"]');
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';

            try {
                let result;
                if (taskId) {
                    // Update existing task
                    result = await window.updateTask(taskId, taskData);
                } else {
                    // Create new task
                    result = await window.addTask(taskData);
                }

                if (result.success) {
                    closeTaskModal(); // Close modal on success
                    // UI refresh is handled by loadUserData called within addTask/updateTask
                } else {
                    // Alert is shown in addTask/updateTask
                    console.error('Failed to save task via handleTaskSubmit');
                }
            } catch (error) {
                // Catch any unexpected errors during the async call
                console.error('Error during handleTaskSubmit:', error);
                alert('An unexpected error occurred while saving the task.');
            } finally {
                // Re-enable button regardless of outcome
                saveButton.disabled = false;
                saveButton.textContent = 'Save Task';
            }
        }

        // Handle task deletion
        async function handleDeleteTask() { 
            const taskId = document.getElementById('task-id').value;
            
            if (!taskId) return; // Should not happen if button is visible

            // Confirmation is now inside window.deleteTask (from auth.js)
            const result = await window.deleteTask(taskId);

            if (result && result.success !== false) { // Check if delete was attempted and didn't explicitly fail
                 closeTaskModal();
                 // UI refresh is handled by loadUserData called within deleteTask
                    } else {
                 // Alert/error handled within deleteTask
                 console.log('Task deletion cancelled or failed.');
            }
        }

        // Exportar tareas a un archivo JSON
        // MODIFIED: Uses window.getUserTasks
        async function exportTasks() { 
            try {
                // Fetch current tasks directly from Firestore via exposed function
                const result = await window.getUserTasks(); 
                if (result.success) {
                    // Convert Timestamps for JSON compatibility (assuming getUserTasks returns them)
                    const tasksToExport = result.tasks.map(task => ({
                        ...task,
                        // Handle potential Timestamps - Check if they exist and are Timestamps
                        createdAt: task.createdAt?.toDate ? task.createdAt.toDate().toISOString() : task.createdAt,
                        updatedAt: task.updatedAt?.toDate ? task.updatedAt.toDate().toISOString() : task.updatedAt,
                        completedDate: task.completedDate?.toDate ? task.completedDate.toDate().toISOString() : task.completedDate,
                        due: task.due?.toDate ? task.due.toDate().toISOString().split('T')[0] : task.due, 
                    }));

                    const dataStr = JSON.stringify(tasksToExport, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                    const exportFileDefaultName = 'little-bug-planner-data.json';
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                } else {
                    alert('Error al obtener las tareas para exportar: ' + (result.error || 'Desconocido'));
                }
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error al exportar datos: ' + error.message);
            }
        }
        
        // Importar tareas desde un archivo JSON
        // MODIFIED: Uses window.addTask
        function importTasks() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const importedTasksRaw = JSON.parse(event.target.result);
                        if (!Array.isArray(importedTasksRaw)) {
                            throw new Error('El archivo JSON no contiene un array.');
                        }

                        // Basic validation of first task structure (optional but good)
                        if (importedTasksRaw.length > 0 && (!importedTasksRaw[0].title || !importedTasksRaw[0].view)) {
                            console.warn('Imported data structure might be incorrect.', importedTasksRaw[0]);
                            // Maybe add more robust validation here
                        }

                        if (!confirm(`${importedTasksRaw.length} tasks will be imported. Continue?`)) {
                            return;
                        }

                        let successCount = 0;
                        let errorCount = 0;
                        const importButton = document.getElementById('import-data-btn');
                        importButton.disabled = true;
                        importButton.textContent = 'Importando...';

                        for (const task of importedTasksRaw) {
                             // Prepare data, removing potential Firestore IDs and ensuring fields exist
                            const taskData = {
                                title: task.title || 'No Title',
                                description: task.description || '',
                                view: task.view || 'planner', // Default view
                                // Planner specific fields
                                priority: task.priority || 'medium',
                                due: task.due || null,
                                type: task.type || 'mandatory',
                                status: task.status || 'todo',
                                // Week specific fields
                                day: task.day || null,
                                time: task.time || null,
                                duration: task.duration || null,
                                // Let Firestore handle timestamps (createdAt, updatedAt)
                                // completedDate might need special handling if importing historical data
                                completedDate: task.completedDate ? new Date(task.completedDate) : null,
                            };

                            // Validate required fields based on view
                            if (taskData.view === 'planner' && !taskData.status) taskData.status = 'todo';
                            if (taskData.view === 'week' && (!taskData.day || !taskData.time || !taskData.duration)){
                                console.warn('Tarea de semana omitida por falta de day/time/duration:', task);
                                errorCount++;
                                continue;
                            }
                            
                            try {
                                const result = await window.addTask(taskData); 
                                if (result.success) {
                                    successCount++;
                                } else {
                                    console.error('Error importando tarea (addTask falló):', task.title, result.error);
                                    errorCount++;
                                }
                            } catch (err) {
                                console.error('Error importando tarea (excepción):', task.title, err);
                                errorCount++;
                            }
                        }

                        importButton.disabled = false;
                        importButton.textContent = 'Importar Datos';
                        alert(`Importación finalizada. ${successCount} tareas importadas, ${errorCount} errores.`);
                        // loadUserData() is called inside addTask, so UI should refresh automatically.

                    } catch (error) {
                        console.error('Error processing import file:', error);
                        alert('Error al procesar el archivo JSON: ' + error.message);
                        const importButton = document.getElementById('import-data-btn');
                        if(importButton){ importButton.disabled = false; importButton.textContent = 'Importar Datos'; }
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Initialize the app
        init();
    </script>
    <!-- Add DragDropTouch for touch support -->
    <script src="https://unpkg.com/dragdroptouch"></script> 
    <div id="joke-modal" class="modal" style="display:none;">
        <div class="modal-content bug-theme text-center p-6 border-4 border-green-400 shadow-xl transform transition-all">
            <div class="bug-icon mb-4">
                <i class="fas fa-bug text-4xl text-green-600"></i>
            </div>
            <h2 class="text-2xl font-bold mb-4 text-green-700">Little Bug tells you!</h2>
            <div class="bg-white p-4 rounded-lg shadow-inner mb-6">
                <p id="joke-text" class="mb-2 text-gray-700 text-lg"></p>
                <p class="text-sm text-green-600 italic">* Coding with humor from 42 Academy *</p>
            </div>
            <button id="close-joke-modal" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-full font-bold hover:from-green-600 hover:to-green-700 transition transform hover:scale-105">
                <i class="fas fa-laugh-beam mr-2"></i> Got it!
            </button>
        </div>
    </div>
    <script type="module">
    import { jokes } from './jokes.js';
    window.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => showJoke(), 1000); // Small delay for better experience
    });
    function showJoke() {
        const modal = document.getElementById('joke-modal');
        const jokeText = document.getElementById('joke-text');
        const closeBtn = document.getElementById('close-joke-modal');
        if (!modal || !jokeText || !closeBtn) return;
        const randomJoke = jokes[Math.floor(Math.random() * jokes.length)];
        jokeText.textContent = randomJoke;
        
        // Show modal with animation
        modal.style.display = 'flex';
        modal.style.opacity = '0';
        setTimeout(() => {
            modal.style.transition = 'opacity 0.5s ease';
            modal.style.opacity = '1';
        }, 10);
        
        closeBtn.onclick = () => {
            // Hide modal with animation
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 500);
        };
    }
    </script>
</body>
</html>